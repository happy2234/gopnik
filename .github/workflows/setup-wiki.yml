name: Setup GitHub Wiki

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update existing wiki pages'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'wiki/**'
      - '.github/workflows/setup-wiki.yml'

jobs:
  setup-wiki:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Check if wiki exists and is accessible
      id: check_wiki
      run: |
        # Try to clone the wiki repository
        if git clone https://github.com/${{ github.repository }}.wiki.git wiki-repo 2>/dev/null; then
          echo "wiki_exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Wiki repository exists and is accessible"
        else
          echo "wiki_exists=false" >> $GITHUB_OUTPUT
          echo "‚ùå Wiki repository does not exist or is not accessible"
          echo "Please enable Wiki in repository settings first:"
          echo "1. Go to https://github.com/${{ github.repository }}/settings"
          echo "2. Scroll to 'Features' section"
          echo "3. Check the 'Wikis' checkbox"
          echo "4. Save changes"
          exit 1
        fi

    - name: Setup wiki content
      if: steps.check_wiki.outputs.wiki_exists == 'true'
      run: |
        cd wiki-repo
        
        echo "üìù Setting up wiki pages..."
        
        # Function to check if file should be ignored
        should_ignore_file() {
          local filename="$1"
          local gitignore_file="../wiki/.gitignore"
          
          # If no .gitignore exists, don't ignore anything
          if [ ! -f "$gitignore_file" ]; then
            return 1
          fi
          
          # Check each pattern in .gitignore
          while IFS= read -r pattern || [ -n "$pattern" ]; do
            # Skip empty lines and comments
            if [[ -z "$pattern" || "$pattern" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # Remove leading/trailing whitespace
            pattern=$(echo "$pattern" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            # Simple pattern matching (supports * wildcards)
            if [[ "$filename" == $pattern ]]; then
              return 0
            fi
          done < "$gitignore_file"
          
          return 1
        }
        
        # Copy all wiki files from the main repository (respecting .gitignore)
        for file in ../wiki/*.md; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            
            # Check if file should be ignored
            if should_ignore_file "$filename"; then
              echo "‚è≠Ô∏è Skipping $filename (ignored by .gitignore)"
              continue
            fi
            
            echo "Processing $filename..."
            
            # Convert filename to wiki format (replace spaces and special chars)
            wiki_name=$(echo "$filename" | sed 's/\.md$//' | sed 's/-/ /g')
            
            # Check if file already exists and force_update is false
            if [ -f "$filename" ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
              echo "‚è≠Ô∏è  Skipping $filename (already exists, use force_update to overwrite)"
              continue
            fi
            
            # Copy the file
            cp "$file" "$filename"
            
            # Add to git
            git add "$filename"
            
            echo "‚úÖ Added $filename to wiki"
          fi
        done
        
        # Check if there are any changes to commit
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          # Commit changes
          git commit -m "üìö Update wiki content from main repository

          Updated wiki pages:
          $(git diff --staged --name-only | sed 's/^/- /')
          
          Auto-generated by GitHub Actions
          Source: ${{ github.sha }}"
          
          # Push changes
          git push origin master
          
          echo "üöÄ Wiki updated successfully!"
        fi

    - name: Create wiki index if needed
      if: steps.check_wiki.outputs.wiki_exists == 'true'
      run: |
        cd wiki-repo
        
        # Check if Home.md exists, if not create a basic one
        if [ ! -f "Home.md" ]; then
          echo "üìÑ Creating Home.md..."
          cat > Home.md << 'EOF'
        # Gopnik Wiki

        Welcome to the Gopnik community wiki! This is a collaborative space where users and developers can share knowledge, examples, and best practices.

        ## üìö Available Pages

        - [Installation Guide](Installation-Guide): Step-by-step installation instructions
        - [Data Models Guide](Data-Models-Guide): Complete guide to Gopnik's data structures
        - [AI Training Guide](AI-Training-Guide): Comprehensive AI model training procedures

        ## ü§ù Contributing

        This wiki is maintained by the community. Anyone can contribute by editing pages and adding examples.

        ## üìû Getting Help

        - [GitHub Discussions](https://github.com/happy2234/gopnik/discussions): Ask questions and get help
        - [Issue Tracker](https://github.com/happy2234/gopnik/issues): Report bugs and request features
        - [Documentation](https://happy2234.github.io/gopnik/): Official documentation
        EOF
          
          git add Home.md
          git commit -m "üìù Create initial Home.md for wiki"
          git push origin master
          
          echo "‚úÖ Created Home.md"
        fi

    - name: Generate wiki summary
      if: steps.check_wiki.outputs.wiki_exists == 'true'
      run: |
        cd wiki-repo
        
        echo "üìä Wiki Summary:"
        echo "==============="
        
        # List all wiki pages
        echo "üìÑ Available Pages:"
        for file in *.md; do
          if [ -f "$file" ]; then
            page_name=$(echo "$file" | sed 's/\.md$//' | sed 's/-/ /g')
            echo "  - $page_name ($file)"
          fi
        done
        
        echo ""
        echo "üîó Wiki URL: https://github.com/${{ github.repository }}/wiki"
        echo "üìù Edit URL: https://github.com/${{ github.repository }}/wiki/_new"
        
        # Check wiki accessibility
        echo ""
        echo "üîç Verifying wiki accessibility..."
        if curl -s -o /dev/null -w "%{http_code}" "https://github.com/${{ github.repository }}/wiki" | grep -q "200"; then
          echo "‚úÖ Wiki is publicly accessible"
        else
          echo "‚ö†Ô∏è  Wiki may not be publicly accessible yet (this is normal for new wikis)"
        fi

    - name: Update repository with wiki status
      if: steps.check_wiki.outputs.wiki_exists == 'true'
      run: |
        # Create a status file
        cat > wiki-status.json << EOF
        {
          "wiki_enabled": true,
          "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "pages_count": $(ls wiki-repo/*.md 2>/dev/null | wc -l),
          "wiki_url": "https://github.com/${{ github.repository }}/wiki",
          "auto_sync": true,
          "status": "active"
        }
        EOF
        
        # Commit status file to main repository
        git add wiki-status.json
        
        if ! git diff --staged --quiet; then
          git commit -m "üìä Update wiki status

          - Wiki setup completed successfully
          - $(ls wiki-repo/*.md 2>/dev/null | wc -l) pages available
          - Auto-sync enabled via GitHub Actions"
          
          git push origin ${{ github.ref_name }}
        fi

    - name: Post setup instructions
      if: steps.check_wiki.outputs.wiki_exists == 'true'
      run: |
        echo ""
        echo "üéâ Wiki Setup Complete!"
        echo "======================"
        echo ""
        echo "üìñ Your wiki is now available at:"
        echo "   https://github.com/${{ github.repository }}/wiki"
        echo ""
        echo "üìù To edit wiki pages:"
        echo "   1. Visit the wiki URL above"
        echo "   2. Click 'Edit' on any page"
        echo "   3. Make your changes and save"
        echo ""
        echo "üîÑ Auto-sync is enabled:"
        echo "   - Changes to wiki/ folder in main repo will auto-update the wiki"
        echo "   - Manual wiki edits will be preserved"
        echo ""
        echo "üìö Available pages:"
        cd wiki-repo
        for file in *.md; do
          if [ -f "$file" ]; then
            page_name=$(echo "$file" | sed 's/\.md$//' | sed 's/-/ /g')
            echo "   - $page_name"
          fi
        done